{% extends 'MenuModule/base.html' %} {% block content %}

<body>
    <!-- <div id="dynamic_menu">

    </div> -->
    <br>

<div class="container">
    <div class="content section col-lg-7 col-md-7" id="main">

    </div>
    <div class='content section'>
        <h1 id="total_price" class="" style="padding-top:150px;"></h1>
        <table class="table table-sm" id="name">
            <tr>
                <th class="text-white text-left">Name</th>
                <th class="text-white text-right">Price</th>
            </tr>
        </table>
    
    </div>
   
    <button type="button" class="btn btn-primary" onclick="send_order()">
        Order
    </button>
</div>

    <script>
        var chatSocket = new WebSocket(
                'ws://' + window.location.host +
                '/ws/customer/');

            chatSocket.onmessage = function(e) {
                console.log(e)
                popup(e)
                };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
        $(document).ready(function() {
            create_menu()
        });


        total_price = 0
        ordered_item = {
            'table_number':1,
            'name':[],
            'price':[],
            'quantity':[]
        }

        order_item_test = {}

        order_item_id = 0

        function add(name, price) {
            if (ordered_item['name'].includes(name))
            {
                index = ordered_item['name'].indexOf(name)
                ordered_item['quantity'][index] += 1  
            }
            else
            {
                ordered_item['name'].push(name);
                ordered_item['price'].push(price);
                ordered_item['quantity'].push(1);
            }
            
            order_item_id += 1
            total_price += parseInt(price)
            $("#name").append(
                '<tr scope="row" class="list-group-item-action text-left" onclick="remove(' + order_item_id + ','+ "'" + name +"'" +')" id = "' + order_item_id + '" ><td>' + name + '</td><td style="width: 10px;" class="text-right">Rs.' + price + '</td></tr>'
            );
            document.getElementById("total_price").innerHTML = total_price;
            
        }

        function remove(order_item_id, name ) {
            if (ordered_item['name'].includes(name))
            {
                $("#" + order_item_id).remove();
                price = 0
                index = ordered_item['name'].indexOf(name)
                price = ordered_item['price'][index]
                if (ordered_item['quantity'][index] <=1 )
                {
                    ordered_item['name'].splice(index,1);
                    ordered_item['price'].splice(index,1);
                    ordered_item['quantity'].splice(index,1);
                }
                else
                {
                    ordered_item['quantity'][index] -= 1
                }
                total_price = total_price - price           
                document.getElementById("total_price").innerHTML = total_price;
            
            }
        }

        function send_order() {
            chatSocket.send(JSON.stringify(ordered_item))
        }

        function create_menu() {
            data = {{ data | safe }}
            outputData(data);
        }

        function outputData(data) {
            for (var food_type in data) {
                $("#dynamic_menu").append(
                    "<li><a href='#" + food_type + "'  class='js-scroll-trigger'>" + food_type + "</a></li>"
                )
                $("#main").append(
                    "<section id='" + food_type + "'><table class='table table-sm'><tbody id='food_data_" + food_type + "'><tr><th class='' colspan='2'>" + food_type + "</th></tr></tbody></table><br><br></section>"
                );
                for (i = 0; i < data[food_type].name.length; i++) {
                    $('#food_data_' + food_type).append(
                        "<tr class='list-group-item-action text-left' scope='row' onclick='add(" + '"' + data[food_type].name[i] + '"' + "," + '"' + data[food_type].price[i] + '"' +")'><td>" + data[food_type].name[i] + "</td><td class='text-right'>Rs." + data[food_type].price[i] + "</td></tr>"
                    )
                }
            }
        }

        function popup(message){
            alert(message)
        }

        $(document).ready(function(){
            $('td').css({
                fontSize: "1rem"
            });
            $('td').css("padding","10px 5px 10px 0px")
            $('th').css("padding","5px 0px 5px 0px")
        });
    </script>
</body>
{% endblock %}