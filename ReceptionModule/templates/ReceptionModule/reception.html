{% extends 'MenuModule/base.html' %} {% block content %}
<body>
    <div class="container" style="height: 1080px; padding: 50px 0px 0px 0px;">
        <div class="card-columns" style="padding-top:80px; padding-bottom:80px;" id = "dynamic_order">
    
        </div>
</div>



<script>
  
    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/reception/');

    chatSocket.onmessage = function(e) {
        data = JSON.parse(e['data']) 
        data =data['message']
        if(data['success'])
        {
            if (data['type'] == "update")
            {
                //ahiale ko lagi remove garyae ko xu .. but update vako order green wa kai ma daykhanae and .. refresh click garyae si balla janae 
                $("#"+data['updated_order']['id']).remove()
                success_popup(data["message"])
            }
        }
        else 
        {
            error_popup(data['message'])
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    function send_data(data)
    {
        chatSocket.send(JSON.stringify(data));
    }
    

    function create_order_block(order)
    {
        $("#dynamic_order").append(
            "<ul><li>"+ order.id +" </li></ul><ul id='"+ order.id +"'></ul>"
            );

        var x = order['ordered_item']['name'].length
        $("#dynamic_order").append(
            '<div class="card" id ='+order.id +' ><div class="card-body"><h5 class="card-title">'+order.table_number+'<br>'+order.state+'</h5><p class="card-text"><small class="text-muted" >'+order.timestamp+'<br>'+order.id +'</small></p><ol style="padding-left:20px" id='+order.id+'_ordered_food> </ol><strong>Total:'+order.paid_price+'<button type="button" class="btn btn-primary" onclick="update_order('+order.id+',' + "'" + 'Done' + "'" + ')">Done</button><button type="button" class="btn btn-primary" onclick="update_order('+order.id+',' + "'" + 'Cancel' + "'" + ')">Cancel</button></div></div>')
        
        for (var nax in order['ordered_item']['name'])
        {
            $("#"+order.id+"_ordered_food").append('<table><tr><td>'+order['ordered_item']['name'][nax]+'</td><td>'+order['ordered_item']['quantity'][nax]+'</td><td>'+ order['ordered_item']['price'][nax]+'</td></tr></table>')
        }    
        
    }

    function get_orders(state)
    {
        console.log(state)
        //success load_data(data)
        //fail fail_popup()
    }

    function error_popup(message)
    {
        console.log(message)
        alert(message)
        // data load error = error_loading_data
        // state change order = error_state_change

    }

    function success_popup(message)
    {
        alert(message)
    }

    function update_order(order_id, state)
    {
        info = {'type':"update",'order_id':order_id, 'state':state}
        send_data(info)
    }

    function load_order(data) 
    {
        orders = data['orders']
        for (i = 0; i< (orders.length); i++)
        {
            create_order_block(orders[i])
        }
    }

    $(document).ready(function() {
            data= {{ data | safe}}
            load_order(data);
    });



</script>
</body>
{% endblock %}
